{% extends 'base.html' %}
{% block title %}Tasks{% endblock %}
{% block content %}
<header class="header">
    <h1 class="greeting">Tasks</h1>
    <p class="subtitle">Manage your tasks and priorities</p>
    <div class="notification" role="button" tabindex="0" aria-label="Notifications" id="notificationTrigger">
        <span class="notification-icon">üîî</span>
        <span class="notification-badge">{{ notifications.count }}</span>
    </div>
</header>
<div class="tasks-section">
    <div class="tasks-header">
        <h2 class="tasks-title">Your Tasks</h2>
        <div class="header-controls">
            <input type="text" class="search-bar" placeholder="Search tasks..." id="searchInput" aria-label="Search tasks">
            <select class="filter-select" id="statusFilter" aria-label="Filter by status">
                <option value="">All Status</option>
                <option value="pending">Pending</option>
                <option value="in-progress">In Progress</option>
                <option value="completed">Completed</option>
            </select>
            <select class="filter-select" id="priorityFilter" aria-label="Filter by priority">
                <option value="">All Priority</option>
                <option value="high">High</option>
                <option value="medium">Medium</option>
                <option value="low">Low</option>
            </select>
            <button class="sort-btn" id="sortBtn" aria-label="Sort tasks">Sort by Deadline ‚Üì</button>
            <button class="view-tasks-btn" data-modal="add-task">Add Task</button>
        </div>
    </div>
    
    <!-- Bulk Actions Bar -->
    <div class="bulk-actions-bar" id="bulkActionsBar" style="display: none;">
        <div class="bulk-actions-info">
            <span id="selectedCount">0</span> task(s) selected
        </div>
        <div class="bulk-actions-buttons">
            <button class="bulk-btn bulk-complete" id="bulkComplete">Mark Complete</button>
            <button class="bulk-btn bulk-delete" id="bulkDelete">Delete Selected</button>
            <button class="bulk-btn bulk-cancel" id="bulkCancel">Cancel</button>
        </div>
    </div>

    <div class="tasks-table-wrapper">
        <table class="tasks-table">
            <thead>
                <tr>
                    <th>
                        <input type="checkbox" id="selectAll" aria-label="Select all tasks">
                    </th>
                    <th>Task Title</th>
                    <th>Assigned To</th>
                    <th>Deadline</th>
                    <th>Priority</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tasksTableBody">
                {% for task in tasks %}
                <tr data-task-id="{{ task.id }}">
                    <td>
                        <input type="checkbox" class="task-checkbox" value="{{ task.id }}" aria-label="Select task">
                    </td>
                    <td class="task-title">{{ task.title }}</td>
                    <td class="assigned-to">
                        {% if task.assigned_to.all %}
                            <div class="assignee-list">
                                {% for user in task.assigned_to.all %}
                                    <div class="assignee">
                                        <span class="assignee-avatar">{{ user.first_name.0|default:user.username.0 }}{{ user.last_name.0|default:"" }}</span>
                                        <span class="assignee-name">{{ user.get_full_name|default:user.username }}</span>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <span class="unassigned">Unassigned</span>
                        {% endif %}
                    </td>
                    <td class="deadline">
                        <span class="deadline-date">{{ task.due_date|date:"M j, Y" }}</span>
                        {% if task.is_overdue %}
                            <span class="overdue-badge">Overdue</span>
                        {% elif task.is_due_soon %}
                            <span class="due-soon-badge">Due Soon</span>
                        {% endif %}
                    </td>
                    <td><span class="priority-{{ task.priority|lower }}">{{ task.priority }}</span></td>
                    <td><span class="status-badge status-{{ task.status|lower }}">{{ task.status }}</span></td>
                    <td class="actions">
                        <button class="action-btn edit-btn" data-modal="edit-task" data-task-id="{{ task.id }}" aria-label="Edit task">
                            <span class="action-icon">‚úèÔ∏è</span>
                        </button>
                        <button class="action-btn delete-btn" data-task-id="{{ task.id }}" aria-label="Delete task">
                            <span class="action-icon">üóëÔ∏è</span>
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="empty-state">
                        No tasks available. <button class="view-tasks-btn" data-modal="add-task">Add a task</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% include 'partials/notifications_modal.html' %}
{% include 'partials/add_task_modal.html' %}
{% include 'partials/edit_task_modal.html' %}
{% endblock %}

{% block extra_css %}
<style>
.tasks-section {
    background: var(--background-white);
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    margin: 20px 0;
}
body.dark-mode .tasks-section {
    background: var(--dark-surface);
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}
.tasks-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    flex-wrap: wrap;
    gap: 15px;
}
.tasks-title {
    font-size: 1.5em;
    font-weight: 600;
    color: var(--text);
    margin: 0;
}
body.dark-mode .tasks-title {
    color: var(--dark-text);
}
.header-controls {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}
.search-bar, .filter-select {
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 0.9em;
    min-width: 150px;
    transition: border-color 0.3s ease;
}
.search-bar {
    min-width: 200px;
}
.search-bar:focus, .filter-select:focus {
    outline: none;
    border-color: var(--primary);
}
body.dark-mode .search-bar,
body.dark-mode .filter-select {
    background: var(--dark-surface);
    border-color: var(--dark-border);
    color: var(--dark-text);
}
.sort-btn {
    background: var(--border-light);
    color: var(--text);
    border: none;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9em;
    transition: all 0.3s ease;
}
.sort-btn:hover {
    background: var(--border);
}
body.dark-mode .sort-btn {
    background: var(--dark-border);
    color: var(--dark-text);
}
.view-tasks-btn {
    background: linear-gradient(135deg, var(--primary), var(--primary-light));
    color: white;
    border: none;
    padding: 8px 24px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.9em;
    transition: all 0.3s ease;
    width: auto;
    display: inline-block;
}
.view-tasks-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 71, 171, 0.3);
}
body.dark-mode .view-tasks-btn {
    background: linear-gradient(135deg, var(--dark-primary), #5ba0f2);
}

/* Bulk Actions Bar */
.bulk-actions-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--primary);
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    animation: slideDown 0.3s ease;
}
body.dark-mode .bulk-actions-bar {
    background: var(--dark-primary);
}
@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
.bulk-actions-info {
    font-weight: 500;
}
.bulk-actions-buttons {
    display: flex;
    gap: 10px;
}
.bulk-btn {
    padding: 6px 12px;
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 6px;
    background: rgba(255,255,255,0.1);
    color: white;
    cursor: pointer;
    font-size: 0.85em;
    transition: all 0.3s ease;
}
.bulk-btn:hover {
    background: rgba(255,255,255,0.2);
}
.bulk-complete:hover {
    background: #2ed573;
    border-color: #2ed573;
}
.bulk-delete:hover {
    background: #ff4757;
    border-color: #ff4757;
}

.tasks-table-wrapper {
    overflow-x: auto;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
.tasks-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--background-white);
}
body.dark-mode .tasks-table {
    background: var(--dark-surface);
}
.tasks-table th {
    background: var(--primary);
    color: white;
    padding: 15px;
    text-align: left;
    font-weight: 600;
    font-size: 0.9em;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
body.dark-mode .tasks-table th {
    background: var(--dark-primary);
}
.tasks-table td {
    padding: 15px;
    border-bottom: 1px solid var(--border-light);
    color: var(--text);
    vertical-align: middle; /* Ensure vertical alignment */
}
body.dark-mode .tasks-table td {
    border-bottom: 1px solid var(--dark-border);
    color: var(--dark-text);
}
.tasks-table tr {
    height: 60px; /* Fixed row height for consistency */
}
.tasks-table tr:hover {
    background: var(--border-light);
}
body.dark-mode .tasks-table tr:hover {
    background: var(--dark-border);
}

/* Assignee Styling */
.assignee-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    max-height: 32px; /* Constrain to single line height */
    overflow: hidden; /* Hide overflow to maintain alignment */
}
.assignee {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    max-width: 150px; /* Limit width of each assignee */
}
.assignee-avatar {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7em;
    font-weight: 600;
    flex-shrink: 0;
}
.assignee-name {
    font-size: 0.8em;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; /* Truncate long names */
}
.unassigned {
    color: var(--text-light);
    font-style: italic;
    font-size: 0.8em;
}
body.dark-mode .unassigned {
    color: var(--dark-text-light);
}

/* Deadline Styling */
.deadline {
    display: flex;
    align-items: center;
    gap: 8px;
}
.overdue-badge {
    background: #ff4757;
    color: white;
    padding: 2px 6px;
    border-radius: 8px;
    font-size: 0.7em;
    font-weight: 500;
}
.due-soon-badge {
    background: #ffa502;
    color: white;
    padding: 2px 6px;
    border-radius: 8px;
    font-size: 0.7em;
    font-weight: 500;
}

/* Priority and Status Badges */
.priority-high {
    background: #ff4757;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: 500;
}
.priority-medium {
    background: #ffa502;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: 500;
}
.priority-low {
    background: #7bed9f;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: 500;
}
.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: 500;
}
.status-completed {
    background: #2ed573;
    color: white;
}
.status-pending {
    background: #ffa502;
    color: white;
}
.status-in-progress {
    background: #3742fa;
    color: white;
}

/* Action Buttons */
.actions {
    display: flex;
    gap: 8px;
}
.action-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 6px;
    border-radius: 6px;
    transition: all 0.3s ease;
}
.action-btn:hover {
    background: var(--border-light);
}
body.dark-mode .action-btn:hover {
    background: var(--dark-border);
}
.edit-btn:hover {
    background: #3742fa;
    color: white;
}
.delete-btn:hover {
    background: #ff4757;
    color: white;
}

.empty-state {
    text-align: center;
    padding: 40px;
    color: var(--text-light);
    font-style: italic;
}
body.dark-mode .empty-state {
    color: var(--dark-text-light);
}

/* Checkbox Styling */
input[type="checkbox"] {
    width: 16px;
    height: 16px;
    cursor: pointer;
}

/* Responsive Design */
@media (max-width: 768px) {
    .header-controls {
        flex-direction: column;
        align-items: stretch;
    }
    .search-bar, .filter-select {
        min-width: 100%;
    }
    .bulk-actions-bar {
        flex-direction: column;
        gap: 10px;
    }
    .bulk-actions-buttons {
        justify-content: center;
    }
    .tasks-table th,
    .tasks-table td {
        padding: 10px 8px;
        font-size: 0.8em;
    }
    .assignee-list {
        max-width: 100px; /* Limit width on smaller screens */
    }
    .assignee {
        max-width: 80px; /* Further limit assignee width */
    }
    .assignee-avatar {
        width: 20px;
        height: 20px;
        font-size: 0.6em;
    }
}
</style>
{% endblock %}
<script>
    const users = JSON.parse('{{ users|escapejs }}');
</script>
{% block extra_js %}
<style>
    .activity-feed-card {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .activity-feed {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 300px;
        overflow-y: auto;
    }
    .activity-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid var(--border);
    }
    .activity-description {
        font-size: 0.9em;
        color: var(--text-primary);
    }
    .activity-timestamp {
        font-size: 0.8em;
        color: var(--text-secondary);
    }
    body.dark-mode .activity-item {
        border-bottom: 1px solid var(--dark-border);
    }
    body.dark-mode .activity-description {
        color: var(--dark-text-primary);
    }
    body.dark-mode .activity-timestamp {
        color: var(--dark-text-secondary);
    }
    .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 10px 20px;
        border-radius: 5px;
        color: white;
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 1000;
    }
    .toast-success {
        background: #2ed573;
    }
    .toast-error {
        background: #ff4757;
    }
    .toast.show {
        opacity: 1;
    }
    .delete-btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
    }
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Helper function to check if due soon
    function isDueSoon(dueDate) {
        const today = new Date();
        const due = new Date(dueDate);
        const diffDays = (due - today) / (1000 * 60 * 60 * 24);
        return 0 <= diffDays && diffDays <= 2;
    }

    // Show toast notification
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Add Task Modal
    document.querySelectorAll('.view-tasks-btn[data-modal="add-task"]').forEach(btn => {
        btn.addEventListener('click', function() {
            const modal = document.getElementById('addTaskModal');
            if (modal) {
                modal.style.display = 'flex';
            } else {
                console.error('Add Task Modal not found');
            }
        });
    });

    // Add Task form submission
    const addTaskForm = document.getElementById('addTaskForm');
    if (addTaskForm) {
        addTaskForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const assignedTo = Array.from(document.getElementById('addAssignedTo').selectedOptions)
                .map(option => option.value);

            const taskData = {
                title: formData.get('title'),
                description: formData.get('description'),
                due_date: formData.get('due_date'),
                status: formData.get('status'),
                priority: formData.get('priority'),
                assigned_to: assignedTo
            };

            fetch('/tasks/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(taskData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const tbody = document.getElementById('tasksTableBody');
                    const newRow = document.createElement('tr');
                    newRow.setAttribute('data-task-id', data.id);
                    
                    let assigneeHtml = '';
                    if (assignedTo.length && typeof users !== 'undefined') {
                        assigneeHtml = `<div class="assignee-list">
                            ${assignedTo.map(id => {
                                const user = users.find(u => u.id == id);
                                if (!user) return '';
                                const displayName = user.full_name.trim() || user.username;
                                const avatarChar = displayName.charAt(0).toUpperCase();
                                return `
                                    <div class="assignee">
                                        <span class="assignee-avatar">${avatarChar}</span>
                                        <span class="assignee-name" title="${displayName}">${displayName}</span>
                                    </div>`;
                            }).join('')}
                        </div>`;
                    } else {
                        assigneeHtml = '<span class="unassigned">Unassigned</span>';
                    }
                    
                    newRow.innerHTML = `
                        <td><input type="checkbox" class="task-checkbox" value="${data.id}" aria-label="Select task"></td>
                        <td class="task-title">${taskData.title}</td>
                        <td class="assigned-to">${assigneeHtml}</td>
                        <td class="deadline">
                            <span class="deadline-date">${new Date(taskData.due_date).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})}</span>
                            ${taskData.due_date < new Date().toISOString().split('T')[0] && taskData.status !== 'Completed' ? '<span class="overdue-badge">Overdue</span>' : ''}
                            ${isDueSoon(taskData.due_date) && taskData.status !== 'Completed' ? '<span class="due-soon-badge">Due Soon</span>' : ''}
                        </td>
                        <td><span class="priority-${taskData.priority.toLowerCase()}">${taskData.priority}</span></td>
                        <td><span class="status-badge status-${taskData.status.toLowerCase().replace(' ', '-')}">${taskData.status}</span></td>
                        <td class="actions">
                            <button class="action-btn edit-btn" data-modal="edit-task" data-task-id="${data.id}" aria-label="Edit task">
                                <span class="action-icon">‚úèÔ∏è</span>
                            </button>
                            <button class="action-btn delete-btn" data-task-id="${data.id}" aria-label="Delete task">
                                <span class="action-icon">üóëÔ∏è</span>
                            </button>
                        </td>
                    `;
                    
                    const emptyState = tbody.querySelector('.empty-state');
                    if (emptyState) {
                        emptyState.parentElement.remove();
                    }
                    
                    tbody.prepend(newRow);
                    
                    document.getElementById('addTaskModal').style.display = 'none';
                    addTaskForm.reset();
                    
                    newRow.querySelector('.edit-btn').addEventListener('click', handleEditButton);
                    newRow.querySelector('.delete-btn').addEventListener('click', handleDeleteButton);
                    newRow.querySelector('.task-checkbox').addEventListener('change', function() {
                        updateBulkActions();
                        updateSelectAll();
                    });
                    
                    // Check if user is creator for delete button
                    newRow.querySelector('.delete-btn').classList.add('disabled');
                    
                    showToast('Task created successfully!', 'success');
                } else {
                    showToast('Error creating task: ' + (data.message || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('An error occurred while creating the task.', 'error');
            });
        });
    }

    // Close Modal Buttons
    document.querySelectorAll('.close-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            this.closest('.modal').style.display = 'none';
        });
    });

    // Bulk selection functionality
    const selectAllCheckbox = document.getElementById('selectAll');
    const taskCheckboxes = document.querySelectorAll('.task-checkbox');
    const bulkActionsBar = document.getElementById('bulkActionsBar');
    const selectedCount = document.getElementById('selectedCount');
    
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const isChecked = this.checked;
            const currentCheckboxes = document.querySelectorAll('.task-checkbox');
            currentCheckboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            updateBulkActions();
        });
    }
    
    taskCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateBulkActions();
            updateSelectAll();
        });
    });
    
    function updateBulkActions() {
        const checkedBoxes = document.querySelectorAll('.task-checkbox:checked');
        const count = checkedBoxes.length;
        
        if (count > 0) {
            bulkActionsBar.style.display = 'flex';
            selectedCount.textContent = count;
        } else {
            bulkActionsBar.style.display = 'none';
        }
    }
    
    function updateSelectAll() {
        const currentCheckboxes = document.querySelectorAll('.task-checkbox');
        const allChecked = Array.from(currentCheckboxes).every(checkbox => checkbox.checked);
        const someChecked = Array.from(currentCheckboxes).some(checkbox => checkbox.checked);
        
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = allChecked;
            selectAllCheckbox.indeterminate = someChecked && !allChecked;
        }
    }
    
    document.getElementById('bulkCancel').addEventListener('click', function() {
        const currentCheckboxes = document.querySelectorAll('.task-checkbox');
        currentCheckboxes.forEach(checkbox => checkbox.checked = false);
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = false;
        }
        bulkActionsBar.style.display = 'none';
    });
    
    document.getElementById('bulkComplete').addEventListener('click', function() {
        const checkedBoxes = document.querySelectorAll('.task-checkbox:checked');
        const taskIds = Array.from(checkedBoxes).map(checkbox => checkbox.value);
        
        if (confirm(`Mark ${taskIds.length} task(s) as complete?`)) {
            fetch('/tasks/bulk_complete/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ task_ids: taskIds })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    checkedBoxes.forEach(checkbox => {
                        const row = checkbox.closest('tr');
                        const statusBadge = row.querySelector('.status-badge');
                        statusBadge.className = 'status-badge status-completed';
                        statusBadge.textContent = 'Completed';
                        const deadlineCell = row.querySelector('.deadline');
                        deadlineCell.querySelectorAll('.overdue-badge, .due-soon-badge').forEach(badge => badge.remove());
                        checkbox.checked = false;
                    });
                    bulkActionsBar.style.display = 'none';
                    if (selectAllCheckbox) {
                        selectAllCheckbox.checked = false;
                    }
                    showToast(`${taskIds.length} task(s) marked as complete`, 'success');
                } else {
                    showToast('Error completing tasks: ' + (data.message || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('An error occurred while completing tasks.', 'error');
            });
        }
    });
    
    document.getElementById('bulkDelete').addEventListener('click', function() {
        const checkedBoxes = document.querySelectorAll('.task-checkbox:checked');
        const taskIds = Array.from(checkedBoxes).map(checkbox => checkbox.value);
        
        if (confirm(`Delete ${taskIds.length} task(s)? This action cannot be undone.`)) {
            fetch('/tasks/bulk_delete/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ task_ids: taskIds })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    checkedBoxes.forEach(checkbox => {
                        checkbox.closest('tr').remove();
                    });
                    bulkActionsBar.style.display = 'none';
                    if (selectAllCheckbox) {
                        selectAllCheckbox.checked = false;
                    }
                    
                    const remainingRows = document.querySelectorAll('#tasksTableBody tr');
                    if (remainingRows.length === 0) {
                        const tbody = document.getElementById('tasksTableBody');
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="7" class="empty-state">
                                    No tasks available. <button class="view-tasks-btn" data-modal="add-task">Add a task</button>
                                </td>
                            </tr>
                        `;
                        tbody.querySelector('.view-tasks-btn').addEventListener('click', function() {
                            const modal = document.getElementById('addTaskModal');
                            if (modal) {
                                modal.style.display = 'flex';
                            }
                        });
                    }
                    showToast(`${taskIds.length} task(s) deleted`, 'success');
                } else {
                    showToast('Error deleting tasks: ' + (data.message || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('An error occurred while deleting tasks.', 'error');
            });
        }
    });
    
    // Sorting functionality
    let sortOrder = 'asc';
    document.getElementById('sortBtn').addEventListener('click', function() {
        sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
        this.textContent = `Sort by Deadline ${sortOrder === 'asc' ? '‚Üë' : '‚Üì'}`;
        sortTasks();
    });
    
    function sortTasks() {
        const tbody = document.getElementById('tasksTableBody');
        const rows = Array.from(tbody.querySelectorAll('tr:not(.empty-state)'));
        
        rows.sort((a, b) => {
            const dateA = new Date(a.querySelector('.deadline-date')?.textContent || '');
            const dateB = new Date(b.querySelector('.deadline-date')?.textContent || '');
            
            return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
        });
        
        rows.forEach(row => tbody.appendChild(row));
    }
    
    // Filtering functionality
    document.getElementById('statusFilter').addEventListener('change', filterTasks);
    document.getElementById('priorityFilter').addEventListener('change', filterTasks);
    document.getElementById('searchInput').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(filterTasks, 300);
    });
    
    function filterTasks() {
        const statusFilter = document.getElementById('statusFilter').value;
        const priorityFilter = document.getElementById('priorityFilter').value;
        const searchQuery = document.getElementById('searchInput').value.toLowerCase();
        
        const rows = document.querySelectorAll('#tasksTableBody tr:not(.empty-state)');
        
        rows.forEach(row => {
            const taskTitle = row.querySelector('.task-title')?.textContent.toLowerCase() || '';
            const taskStatus = row.querySelector('.status-badge')?.textContent.toLowerCase() || '';
            const taskPriority = row.querySelector('[class*="priority-"]')?.textContent.toLowerCase() || '';
            
            const matchesSearch = taskTitle.includes(searchQuery);
            const matchesStatus = !statusFilter || taskStatus.includes(statusFilter);
            const matchesPriority = !priorityFilter || taskPriority.includes(priorityFilter);
            
            row.style.display = matchesSearch && matchesStatus && matchesPriority ? '' : 'none';
        });
        
        const visibleRows = document.querySelectorAll('#tasksTableBody tr:not([style*="display: none"])');
        if (visibleRows.length === 0 && !document.querySelector('#tasksTableBody .empty-state')) {
            const tbody = document.getElementById('tasksTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="empty-state">
                        No tasks available. <button class="view-tasks-btn" data-modal="add-task">Add a task</button>
                    </td>
                </tr>
            `;
            tbody.querySelector('.view-tasks-btn').addEventListener('click', function() {
                const modal = document.getElementById('addTaskModal');
                if (modal) {
                    modal.style.display = 'flex';
                }
            });
        } else if (visibleRows.length > 0) {
            const emptyState = tbody.querySelector('.empty-state');
            if (emptyState) {
                emptyState.parentElement.remove();
            }
        }
    }
    
    // Edit Task Modal
    function handleEditButton() {
        const taskId = this.getAttribute('data-task-id');
        
        fetch(`/tasks/${taskId}/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            const editModal = document.getElementById('editTaskModal');
            if (editModal) {
                const form = editModal.querySelector('#editTaskForm');
                const titleField = editModal.querySelector('#editTitle');
                const descriptionField = editModal.querySelector('#editDescription');
                const statusField = editModal.querySelector('#editStatus');
                const priorityField = editModal.querySelector('#editPriority');
                const dueDateField = editModal.querySelector('#editDueDate');
                const assignedToField = editModal.querySelector('#editAssignedTo');
                const taskIdField = editModal.querySelector('#editTaskId');
                
                taskIdField.value = taskId;
                titleField.value = data.title;
                descriptionField.value = data.description || '';
                statusField.value = data.status;
                priorityField.value = data.priority;
                dueDateField.value = data.due_date;
                
                // Clear and set assigned users
                Array.from(assignedToField.options).forEach(option => {
                    option.selected = data.assigned_to.some(user => user.id == option.value);
                });
                
                editModal.style.display = 'flex';
                
                // Update delete button visibility
                const row = document.querySelector(`tr[data-task-id="${taskId}"]`);
                const deleteBtn = row.querySelector('.delete-btn');
                if (!data.is_creator) {
                    deleteBtn.classList.add('disabled');
                } else {
                    deleteBtn.classList.remove('disabled');
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error loading task details.', 'error');
        });
    }
    
    // Edit Task form submission
    const editTaskForm = document.getElementById('editTaskForm');
    if (editTaskForm) {
        editTaskForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const taskId = this.querySelector('#editTaskId').value;
            const formData = new FormData(this);
            const assignedTo = Array.from(document.getElementById('editAssignedTo').selectedOptions)
                .map(option => option.value);
            
            const taskData = {
                title: formData.get('title'),
                description: formData.get('description') || '',
                due_date: formData.get('due_date'),
                status: formData.get('status'),
                priority: formData.get('priority'),
                assigned_to: assignedTo
            };
            
            fetch(`/tasks/${taskId}/edit/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(taskData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    fetch(`/tasks/${taskId}/`, {
                        method: 'GET',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    })
                    .then(response => response.json())
                    .then(taskDetails => {
                        const row = document.querySelector(`tr[data-task-id="${taskId}"]`);
                        if (row) {
                            row.querySelector('.task-title').textContent = taskDetails.title;
                            const deadlineCell = row.querySelector('.deadline');
                            deadlineCell.innerHTML = `
                                <span class="deadline-date">${new Date(taskDetails.due_date).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})}</span>
                                ${taskDetails.due_date < new Date().toISOString().split('T')[0] && taskDetails.status !== 'Completed' ? '<span class="overdue-badge">Overdue</span>' : ''}
                                ${isDueSoon(taskDetails.due_date) && taskDetails.status !== 'Completed' ? '<span class="due-soon-badge">Due Soon</span>' : ''}
                            `;
                            const prioritySpan = row.querySelector('[class*="priority-"]');
                            prioritySpan.className = `priority-${taskDetails.priority.toLowerCase()}`;
                            prioritySpan.textContent = taskDetails.priority;
                            const statusSpan = row.querySelector('.status-badge');
                            statusSpan.className = `status-badge status-${taskDetails.status.toLowerCase().replace(' ', '-')}`;
                            statusSpan.textContent = taskDetails.status;
                            
                            const assigneeCell = row.querySelector('.assigned-to');
                            if (taskDetails.assigned_to && taskDetails.assigned_to.length > 0) {
                                assigneeCell.innerHTML = `<div class="assignee-list">
                                    ${taskDetails.assigned_to.map(user => {
                                        const displayName = user.full_name.trim() || user.username;
                                        const avatarChar = displayName.charAt(0).toUpperCase();
                                        return `
                                            <div class="assignee">
                                                <span class="assignee-avatar">${avatarChar}</span>
                                                <span class="assignee-name" title="${displayName}">${displayName}</span>
                                            </div>`;
                                    }).join('')}
                                </div>`;
                            } else {
                                assigneeCell.innerHTML = '<span class="unassigned">Unassigned</span>';
                            }
                            
                            // Update delete button visibility
                            const deleteBtn = row.querySelector('.delete-btn');
                            if (!taskDetails.is_creator) {
                                deleteBtn.classList.add('disabled');
                            } else {
                                deleteBtn.classList.remove('disabled');
                            }
                        }
                        
                        document.getElementById('editTaskModal').style.display = 'none';
                        showToast('Task updated successfully!', 'success');
                    })
                    .catch(error => {
                        console.error('Error fetching task details:', error);
                        showToast('Error loading updated task details.', 'error');
                    });
                } else {
                    showToast('Error updating task: ' + (data.message || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('An error occurred while updating the task.', 'error');
            });
        });
    }
    
    // Delete Task functionality
    function handleDeleteButton() {
        const taskId = this.getAttribute('data-task-id');
        const row = this.closest('tr');
        const taskTitle = row.querySelector('.task-title').textContent;
        
        if (this.classList.contains('disabled')) {
            showToast('Only the task creator can delete this task.', 'error');
            return;
        }
        
        if (confirm(`Are you sure you want to delete "${taskTitle}"? This action cannot be undone.`)) {
            fetch(`/tasks/${taskId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    row.remove();
                    const remainingRows = document.querySelectorAll('#tasksTableBody tr');
                    if (remainingRows.length === 0) {
                        const tbody = document.getElementById('tasksTableBody');
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="7" class="empty-state">
                                    No tasks available. <button class="view-tasks-btn" data-modal="add-task">Add a task</button>
                                </td>
                            </tr>
                        `;
                        tbody.querySelector('.view-tasks-btn').addEventListener('click', function() {
                            const modal = document.getElementById('addTaskModal');
                            if (modal) {
                                modal.style.display = 'flex';
                            }
                        });
                    }
                    showToast('Task deleted successfully!', 'success');
                } else {
                    showToast('Error deleting task: ' + (data.message || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('An error occurred while deleting the task.', 'error');
            });
        }
    }
    
    // Attach edit and delete button event listeners
    function initializeTaskButtons() {
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.removeEventListener('click', handleEditButton); // Prevent duplicate listeners
            btn.addEventListener('click', handleEditButton);
        });
        
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.removeEventListener('click', handleDeleteButton); // Prevent duplicate listeners
            btn.addEventListener('click', handleDeleteButton);
            // Check if user is creator for existing tasks
            const taskId = btn.getAttribute('data-task-id');
            fetch(`/tasks/${taskId}/`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (!data.is_creator) {
                    btn.classList.add('disabled');
                }
            })
            .catch(error => {
                console.error('Error checking creator status:', error);
            });
        });
    }
    
    // Initialize buttons on page load
    initializeTaskButtons();
    
    // Modal close functionality
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
            e.target.style.display = 'none';
        }
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        }
        if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
            e.preventDefault();
            const modal = document.getElementById('addTaskModal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }
    });
    
    // Notification functionality
    const notificationTrigger = document.getElementById('notificationTrigger');
    if (notificationTrigger) {
        notificationTrigger.addEventListener('click', function() {
            const modal = document.getElementById('notificationsModal');
            if (modal) {
                modal.style.display = 'flex';
            }
        });
    }
    
    // Auto-save search and filter preferences
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const priorityFilter = document.getElementById('priorityFilter');
    
    if (localStorage.getItem('taskSearch')) {
        searchInput.value = localStorage.getItem('taskSearch');
    }
    if (localStorage.getItem('taskStatusFilter')) {
        statusFilter.value = localStorage.getItem('taskStatusFilter');
    }
    if (localStorage.getItem('taskPriorityFilter')) {
        priorityFilter.value = localStorage.getItem('taskPriorityFilter');
    }
    
    filterTasks();
    
    searchInput.addEventListener('input', function() {
        localStorage.setItem('taskSearch', this.value);
    });
    
    statusFilter.addEventListener('change', function() {
        localStorage.setItem('taskStatusFilter', this.value);
    });
    
    priorityFilter.addEventListener('change', function() {
        localStorage.setItem('taskPriorityFilter', this.value);
    });
    
    // Periodic refresh for real-time updates
    function fetchTaskUpdates() {
        fetch('/tasks/check_updates/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success' && data.has_updates) {
                showToast('New tasks assigned! Refreshing task list.', 'success');
                location.reload(); // Simplified to reload for full table update
            }
        })
        .catch(error => {
            console.error('Error checking for updates:', error);
            showToast('Error checking for task updates.', 'error');
        });
    }
    
    setInterval(fetchTaskUpdates, 30000);
    
    // Initialize tooltips for icons and assignee names
    document.querySelectorAll('[aria-label], .assignee-name').forEach(element => {
        element.setAttribute('title', element.getAttribute('aria-label') || element.textContent);
    });
    
    // Performance optimization: Debounce search input
    let searchTimeout;
    searchInput.removeEventListener('input', filterTasks);
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(filterTasks, 300);
    });
    
    // Additional utility functions
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric'
        });
    }

    // Export functions for use in other modules
    window.TasksPage = {
        filterTasks: filterTasks,
        sortTasks: sortTasks,
        formatDate: formatDate,
        showToast: showToast
    };

    console.log('Tasks page initialized successfully');
});
</script>
{% endblock %}